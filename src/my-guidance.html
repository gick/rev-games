<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/geo-location/geo-location.html">
<link rel="import" href="../bower_components/google-map/google-map.html">
<link rel="import" href="./element/orientation/map-display.html">
<link rel="import" href="./element/orientation/my-orientation.html">
<link rel="import" href="./element/orientation/my-compass.html">
<link rel="import" href="./element/orientation/my-ping.html">
<link rel="import" href="./element/ui-indicators/swipe-allowed.html">

<dom-module id="my-guidance">
    <template>
        <style>
            :host {
                @apply(--layout-fullbleed);
                @apply(--layout-vertical);
            }

            .card {
                box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);
                padding: 16px;
                margin: 24px;
                border-radius: 5px;
                background-color: #fff;
                color: #757575;
            }

            .circle {
                display: inline-block;
                height: 64px;
                width: 64px;
                border-radius: 50%;
                background: #ddd;
                line-height: 64px;
                font-size: 30px;
                color: #555;
                text-align: center;
            }

            h1 {
                font-size: 22px;
                margin: 16px 0;
                color: #212121;
            }
        </style>
        <paper-button raised on-click="nextActivity">Next</paper-button>
        <my-orientation angle="{{angle}}"></my-orientation>
        <geo-location high-accuracy watch-pos id="loc"></geo-location>
        <paper-card heading="Atteindre la localisation" image="" elevation="1" animated-shadow="false">
            <div class="card-content">
                <paper-icon-button style="position: relative;float:right;margin-right: 50px" icon="vaadin:question-circle" on-click="showInstruction">
                </paper-icon-button>
                <div>
                    <map-display doc-mkdown='{{docMkdown}}' id="map" user-lat={{userLat}} user-lng={{userLng}} lat="[[pageActivity.latitude]]" long="[[pageActivity.longitude]]"
                        poi={{poi}}></map-display>
                </div>
            </div>
            <swipe-allowed swipe-allowed=[[swipeAllowed]]></swipe-allowed>
        </paper-card>

            <paper-toast id="userAtpoi" text="Point d'intérêt atteint !"></paper-toast>
            <paper-dialog id="poiReached">
                <h2>Destination atteinte!</h2>
                <div>Vous pouvez maintenant accéder à la page suivante</div>
                <div class="buttons">
                    <paper-button dialog-confirm autofocus>OK</paper-button>
                </div>
            </paper-dialog>
            <paper-dialog id="docPage">
                <marked-element markdown="{{docMkdown}}">
                    <div class="markdown-html"></div>
                </marked-element>
                <div class="buttons">
                    <paper-button dialog-confirm autofocus>OK</paper-button>
                </div>
            </paper-dialog>

    </template>
    <script>
        Polymer({

            ready: function () {
                this.$.map.addEventListener('google-map-ready', this.mapready.bind(this));
                this.set('mapready', false)

                this.$.loc.addEventListener('geo-response',
                    this.updateCoord.bind(this));
            },
            mapready: function () {
                this.set('mapready', true)
            },
            setPOI: function () {
                this.$$('#map').showPOI(this.pageActivity)
            },

            _hasInstruction: function () {
                return false
                if (!this.docMkdown) {
                    return true
                }
                return false
            },

            setpoi: function () {
                //called if the map component has already been loaded
                if (this.$$('#map') && this.$$map.mapready) {
                    this.$.map.mapready()
                }
            },
            setCard: function () {
                this.set('ismap', true)
            },
            updateCoord: function (e) {
                if (!this.mapready) {
                    return
                }
                if (this.pageActivity) {
                    var coord = {
                        lat: e.detail.latitude,
                        lng: e.detail.longitude
                    }
                    this.headingDistance = google.maps.geometry.spherical.computeDistanceBetween(new google
                        .maps.LatLng(coord), new google.maps.LatLng({
                            lat: this.pageActivity.latitude,
                            lng: this.pageActivity.longitude
                        }))
                    if (this.initialHeadingDistance == null) {
                        this.initialHeadingDistance = this.headingDistance
                    }
                    this.userReachpoi(this.headingDistance)
                    if (this.$$('#map'))
                        this.$$('#map').updateUser(coord)
                }
            },

            showDistance: function () {
                this.$.distToast.open()
            },

            showInstruction: function () {
                this.$.docPage.open()
            },

            _computeDistance: function (distance) {
                return "Distance restante : " + Math.round(distance) + " mètres."
            },

            userReachpoi: function (newDistance) {
                if (newDistance == 0) {
                    return
                }
                if (this.pageActivity) {
                    if (newDistance <= this.poi.map.areaRadius) {
                        this.poiReached=true
                        this.$.userAtpoi.open()
                        this.$.poiReached.open()
                    }
                }
            },

            nextActivity: function () {
                this.poiReached=true
    
                this.swipeAllowed=true
                this.$.userAtpoi.open()
                this.$.poiReached.open()
            },

            is: 'my-guidance',


            property: {
                swipeAllowed: {
                    type: Boolean,
                    notify: true,
                },
                pageActivity: {
                    type: Object,
                    notify: true,
                },
                docMkdown: {
                    type: String,
                    notify: true,
                },
                ismap: {
                    type: Boolean,
                    notify: true,
                    value: true,
                },
                isping: {
                    type: Boolean,
                    notify: true,
                },
                iscompass: {
                    type: Boolean,
                    notify: true,
                },
                headingDistance: {
                    type: Number,
                    notify: true,
                    observer: 'userReachpoi'
                },

                headingDegree: {
                    type: Number,
                    notify: true
                },

                initialHeadingDistance: {
                    type: Number,
                    notify: true
                },

            }
        });
    </script>
</dom-module>