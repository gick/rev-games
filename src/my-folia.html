<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/file-upload/file-upload.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../bower_components/bitter-alert/bitter-alert.html">
<link rel="import" href="./element/helper/next-page.html">
<link rel="import" href="./element/coloriage/coloriageElement.html">
<link rel="import" href="./element/chatroom/imageResizer.html">
<link rel="import" href="./element/foliaElements/progressView.html">

<dom-module id="my-folia">
  <template>
    <style>
      :host {
        @apply(--layout-fullbleed);
        @apply(--layout-vertical);
      }

      .file-upload {
        background-color: darkseagreen;
      }


      .card {
        box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);
        padding: 16px;
        margin: 24px;
        border-radius: 5px;
        background-color: #fff;
        color: #757575;
      }

      paper-card {
        display: block;
      }


      h1 {
        font-size: 22px;
        margin: 16px 0;
        color: #212121;
      }
    </style>


    <iron-ajax method="POST" content-type="application/json" on-response="enableFolia" body=[[bodyParam]] url="/coloriage/[[foliaId]]"
      id="coloriageUpload"></iron-ajax>
    <iron-ajax method="GET" content-type="application/json" url="/execFolia/[[foliaId]]" id="startFolia"></iron-ajax>
    <iron-ajax method="GET" content-type="application/json" last-response={{populatedInstance}} on-response="showResult" url="/foliaInstance/[[foliaId]]"
      id="populatedInstance"></iron-ajax>
    <bitter-alert id="tutorial1" image-url="/images/tuto1.jpg" text="Prendre une photo de la feuille vue de face" title="Utiliser la reconnaissance"
      confirm-button-text="Compris"></bitter-alert>
    <bitter-alert id="tutorial2" image-url="/images/tuto2.png" text="Tracer une ligne parcourant la feuille de haut en bas sur la photo"
      title="Utiliser la reconnaissance" confirm-button-text="Compris"></bitter-alert>
    <bitter-alert id="tutorial3" image-url="/images/tuto3.png" text="Quand vous êtes satisfait du résultat, appuyer sur Confirmer, puis sur Reconnaissance"
      title="Utiliser la reconnaissance" confirm-button-text="Compris"></bitter-alert>
    <bitter-alert id="foliaSuccess" image-url="/images/success.jpg" text="" title="Bravo vous avez réussi" confirm-button-text="Super!"></bitter-alert>
    <bitter-alert id="foliaFail" image-url="/images/fail.jpg" text="Vous n'avez pas identifié le bon arbre" title="C'est raté" confirm-button-text="Zut alors!"></bitter-alert>

    <bitter-alert id="foliaBug" image-url="/images/bugFolia.png" text="Désolé, un bug a mangé votre image, merci de réessayer"
      title="Alerte au bug" confirm-button-text="OK"></bitter-alert>


    <paper-card heading="Reconnaissance automatique de feuilles" image="" elevation="2" animated-shadow="false">
      <div class="card-content">
        Pour cette activité, vous allez devoir identifier une feuille de chêne commun parmis les feuilles proposées.
        <br> Vous pouvez accéder au tutoriel de l'activité en pressant le bouton tutoriel (recommandé)
        <paper-button raised style="background-color: green;" on-click="startTutorial">Tutoriel</paper-button>
        <div class="photoContainer">
          <image-resizer class="uploader" id='uploader' on-success="leafUpdated" additional=[[userParam]] name="Prendre photo" url="/leaf"></image-resizer>
        </div>
        <template is="dom-if" if="[[foliaRun]]">
          <progress-view current-message={{currentMessage}} current-step={{currentStep}}></progress-view>
        </template>

        <coloriage-element id="coloriage" file-id=[[leafId]]></coloriage-element>
        <div class="card-actions">
          <paper-button disabled=[[!foliaReady]] raised on-click="startFolia">Reconnaissance</paper-button>
        </div>
        <div>Debug element : liste espèce reconnue
          <template is="dom-repeat" items=[[populatedInstance.resultCSV]]>
            <div>[[item]]</div>
          </template>
          </div>
    </paper-card>

  </template>
  <script>
    Polymer({
      is: 'my-folia',
      ready: function () {
        this.$.coloriage.addEventListener('imageEncoded', this.uploadColoriage.bind(this))
        this.currentStep = 0
        this.foliaReady = false
      },
      enableFolia: function () {
        this.foliaReady = true
      },
      startTutorial: function () {
        var tutorial2 = this.$.tutorial2
        var tutorial3 = this.$.tutorial3
        this.$.tutorial1.onConfirm = function () {
          tutorial2.open()
        }.bind(this)
        this.$.tutorial2.onConfirm = function () {
          tutorial3.open()
        }.bind(this)
        this.$.tutorial3.onConfirm = function () {}
        this.$.tutorial1.open()
      },

      setupListener: function (uid) {
        var that = this
        this.currentStep = 0
        firebase.database().ref('users/' + uid + '/folia/').remove()
        var messageRef = firebase.database().ref('users/' + uid + '/folia/messages/')
        var endRef = firebase.database().ref('users/' + uid + '/folia/end/')
        var errorRef = firebase.database().ref('users/' + uid + '/folia/errors/')

        messageRef.on('child_added', function (child) {
          that.foliaRun = true
          that.currentStep = that.currentStep + 1
          that.currentMessage = child.val().data
        })
        endRef.on('child_added', function () {
          that.foliaRun = false
          that.$.populatedInstance.generateRequest()
        })
        errorRef.on('child_added', that.showError.bind(that))
      },
      showError: function () {
        this.foliaRun = false
        this.$.foliaBug.open()
      },
      showResult: function () {
        let success = false
        if (this.populatedInstance && this.populatedInstance.resultCSV) {
          let results = this.populatedInstance.resultCSV
          for (var i = 0; i < results.length; results++) {
            if (results[i].indexOf(this.correctResponse) > -1) {
              success = true
            }
          }
        }
        if (success) {
          this.$.foliaSuccess.open()
        } else {
          this.$.foliaFail.open()
        }
      },
      startFolia: function () {
        firebase.database().ref('users/' + this.userId + '/folia/').remove()

        this.$.startFolia.generateRequest()
      },
      startDebugFolia: function () {
        firebase.database().ref('users/' + this.userId + '/folia/').remove()

        this.$.startDebugFolia.generateRequest()
      },

      uploadColoriage: function (evt) {
        var bodyParam = {
          dataURI: evt.detail.image
        }
        this.bodyParam = null
        this.bodyParam = bodyParam
        this.$.coloriageUpload.generateRequest()
      },
      leafUpdated: function (evt) {
        let result = JSON.parse(evt.detail.xhr.response)
        this.leafId = result.resource.leafId
        this.foliaId = result.resource._id
      },
      properties: {
        foliaId: {
          type: String,
          reflectToAttribute: true,
        },
        userId: {
          type: String,
          notify: true,
          observer: '_userChanged'
        },
        correctResponse: {
          type: String,
          notify: true,
        }

      },
      _userChanged: function (newVal, oldVal) {
        if (newVal) {
          this.userParam = {
            userId: newVal
          }
          this.setupListener(newVal)
        }

      }
    });
  </script>
</dom-module>