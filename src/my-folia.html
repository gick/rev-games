<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/file-upload/file-upload.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="./element/helper/next-page.html">
<link rel="import" href="./element/coloriage/coloriageElement.html">
<link rel="import" href="./element/foliaElements/eventSourceManager.html">
<link rel="import" href="./element/foliaElements/foliaResultDisplay.html">

<dom-module id="my-folia">
  <template>
        <style>
         :host {
            display: block;
            padding: 10px;
        }
.hiddenClass{
  display:none;
}
.fadeOut {
    visibility: hidden;
    opacity: 0;
    transition: visibility 0s linear 1000ms, opacity 1000ms;
}
.fadeIn {
    visibility: visible;
    opacity: 1;
    transition: visibility 0s linear 0s, opacity 1000ms;
}

        .card {
            box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);
            padding: 16px;
            margin: 24px;
            border-radius: 5px;
            background-color: #fff;
            color: #757575;
        }

        paper-card {
            display: block;
        }


        h1 {
            font-size: 22px;
            margin: 16px 0;
            color: #212121;
        }
        </style>


<iron-ajax method="POST" content-type="application/json" on-response="checkFoliaReady" body=[[bodyParam]] url="/coloriage/[[foliaId]]" id="coloriageUpload"></iron-ajax>
<iron-ajax method="GET" content-type="application/json" on-response="uploadDone" url="/uploadfiles/[[foliaId]]" id="uploadDocker"></iron-ajax>

<paper-card heading="Utilisation de Folia" image="" elevation="2" animated-shadow="false">
  <div class="card-content">
    <div>
      Prenez une photo de la feuille :
      <file-upload name="Leaf" on-success="updateLeaf" id="imageScan" method="POST" accept="image/*;capture=camera" target="/leaf">Feuille
      </file-upload>
    </div>
    <div id="coloriage" class$={{colorClass}}>
      <coloriage-element id="" file-id=[[leafId]]></coloriage-element>
    </div>
    <div id="computation" class$={{eventClass}}>
      <event-source-manager id="eventSourceManager" folia-id=[[foliaId]]></event-source-manager>
    </div>
    <div id="result" class$={{resultClass}}>
      <folia-result-display id="resultDisplay" folia-id=[[foliaId]]></folia-result-display>

    </div>

    <div class="card-actions">
      <paper-button raised on-click="uploadDocker">Start Folia</paper-button>
    </div>

</paper-card>

</template>
 <script>
    Polymer({
      is: 'my-folia',
      ready: function() {
        this.$.coloriage.addEventListener('imageEncoded', this.uploadColoriage.bind(this))
        this.foliaReady = false
        this.eventClass='hiddenClass'
        this.resultClass='hiddenClass'
        this.$.coloriage.addEventListener("transitionend", this.animationEnd.bind(this),false);
        this.$.eventSourceManager.addEventListener('finishComputation',this.finishComputation.bind(this))
      },
      animationEnd:function(arg){
        if(event.propertyName=='visibility'){
          this.colorClass='hiddenClass'
          this.eventClass='fadeIn'
        }
      },
      finishComputation:function(){
        this.eventClass='hiddenClass'
        this.resultClass='fadeIn'
        this.$.resultDisplay.populate()
      },
      uploadDone: function() {
        this.$.eventSourceManager.startFolia()
        this.colorClass = 'fadeOut'
        this.eventClass = 'fadeIn'
      },
      checkFoliaReady: function(evt) {
        var res = evt.detail.__data__.response
        if (res.success) {
          this.foliaReady = true
        }
      },
      uploadDocker: function() {
        this.$.uploadDocker.generateRequest()
      },
      uploadColoriage: function(evt) {
        var bodyParam = {
          dataURI: evt.detail.image
        }
        this.bodyParam = null
        this.bodyParam = bodyParam
        this.$.coloriageUpload.generateRequest()
      },
      updateLeaf: function(evt) {
        let result = JSON.parse(evt.detail.xhr.response)
        this.leafId = result.resource.leaf
        this.foliaId = result.resource._id
      },
      property: {}
    });
  </script>
</dom-module>
